<%# 
  Partial for rendering a single chunk of law content
  Used by Turbo Stream for progressive loading
  Matches EXACTLY the structure from _content.html.erb for CSS compatibility
%>
<% if stream.present? %>
  <% article_iterator = (chunk_metadata&.dig(:current_page) || 1 - 1) * (chunk_metadata&.dig(:chunk_size) || 200) %>
  <% bigger_section_iterator = 0 %>
  
  <% stream.each do |stream| %>
    <% if stream.instance_of? Book %>
      <div class="bigger-section" id="bigger_section_<%= bigger_section_iterator %>" last_article="<%= article_iterator - 1 %>" next_article="<%= article_iterator %>">
        <h2 id="book_<%= stream.position %>">
          Libro <%= stream.number %>
          <% if @user_can_edit_law && defined?(is_editor_mode_enabled) && is_editor_mode_enabled %>
            <%= link_to '<i class="fas fa-edit"></i>'.html_safe, edit_book_path(stream) %>
          <% end %>
        </h2>
        <h3><%= stream.name %></h3>
      </div>
      <% bigger_section_iterator += 1 %>
    <% end %>
    <% if stream.instance_of? Title %>
      <div class="bigger-section" id="bigger_section_<%= bigger_section_iterator %>" last_article="<%= article_iterator - 1 %>" next_article="<%= article_iterator %>">
        <h2 class="title" id="title_<%= stream.position %>">
          Título <%= stream.number %>
          <% if @user_can_edit_law && defined?(is_editor_mode_enabled) && is_editor_mode_enabled %>
            <%= link_to '<i class="fas fa-edit"></i>'.html_safe, edit_title_path(stream) %>
          <% end %>
        </h2>
        <h3 class="title-name"><%= stream.name %></h3>
      </div>
      <% bigger_section_iterator += 1 %>
    <% end %>
    <% if stream.instance_of? Chapter %>
      <div class="bigger-section" id="bigger_section_<%= bigger_section_iterator %>" last_article="<%= article_iterator - 1 %>" next_article="<%= article_iterator %>">
        <h3 class="chapter" id="chapter_<%= stream.position %>">
          Capítulo <%= stream.number %>
          <% if @user_can_edit_law && defined?(is_editor_mode_enabled) && is_editor_mode_enabled %>
            <%= link_to '<i class="fas fa-edit"></i>'.html_safe, edit_chapter_path(stream) %>
          <% end %>
        </h3>
        <h3 class="chapter-name"><%= stream.name %></h3>
      </div>
      <% bigger_section_iterator += 1 %>
    <% end %>
    <% if stream.instance_of? Section %>
      <div class="bigger-section" id="bigger_section_<%= bigger_section_iterator %>" last_article="<%= article_iterator - 1 %>" next_article="<%= article_iterator %>">
        <h4 class="section" id="section_<%= stream.position %>">
          Sección <%= stream.number %>
          <% if @user_can_edit_law && defined?(is_editor_mode_enabled) && is_editor_mode_enabled %>
            <%= link_to '<i class="fas fa-edit"></i>'.html_safe, edit_section_path(stream) %>
          <% end %>
        </h4>
        <h4 class="section-name"><%= stream.name %></h4>
      </div>
      <% bigger_section_iterator += 1 %>
    <% end %>
    <% if stream.instance_of? Subsection %>
      <div class="bigger-section" id="bigger_section_<%= bigger_section_iterator %>" last_article="<%= article_iterator - 1 %>" next_article="<%= article_iterator %>">
        <h5 class="subsection" id="subsection_<%= stream.position %>">
          Subsección <%= stream.number %>
          <% if @user_can_edit_law && defined?(is_editor_mode_enabled) && is_editor_mode_enabled %>
            <%= link_to '<i class="fas fa-edit"></i>'.html_safe, edit_subsection_path(stream) %>
          <% end %>
        </h5>
        <h5 class="subsection-name"><%= stream.name %></h5>
      </div>
      <% bigger_section_iterator += 1 %>
    <% end %>
    <% if stream.instance_of? Article %>
      <div id="article_<%= article_iterator %>">
        <div class="article-p" id="article_<%= stream.position %>" style="padding: .5rem 1.5rem">
          <b>
            Artículo <%= stream.number %>
            <% if @user_can_edit_law && defined?(is_editor_mode_enabled) && is_editor_mode_enabled %>
              <%= link_to '<i class="fas fa-edit"></i>'.html_safe, edit_law_path(stream.law, article_number: stream.number ) %>
            <% end %>
          </b>
          <% if @highlight_enabled %>
            <%= stream.pg_search_highlight.gsub(/<(?!\/?b(?=>|\s.*>))\/?.*?>/, '').html_safe %>.
          <% else %>
            <%= stream.class.markdown.render(stream.body).html_safe %>
          <% end %>
        </div>
      </div>
      <% article_iterator += 1 %>
    <% end %>
  <% end %>
<% end %>